flowchart TD
    %% 1. Setup & Init
    Start((Start))
    
    subgraph Init [Phase I: Bootstrap]
        direction TB
        LoadLib[[source lib/utils.sh]]
        CheckRoot{Is Root?}
        CheckDistro{Is Debian?}
    end

    %% 2. Sequential Execution (Unrolled Loop)
    %% Showing specific script names as requested
    subgraph Steps [Phase II: Modular Scripts]
        direction TB
        
        %% Defining Nodes with specific Script Names
        Step00["00_preflight.sh<br/>(System Checks)"]
        Step01["01_base_deps.sh<br/>(Apt Update & Base)"]
        Step02["02_video_input.sh<br/>(Drivers & Libinput)"]
        Step03["03_wayland_core.sh<br/>(Labwc & Wlroots)"]
        Step04["04_waybar_setup.sh<br/>(Bar Installation)"]
        Step05["05_user_config.sh<br/>(Dotfiles Link)"]

        %% Connecting the sequential flow
        Step00 --> Step01
        Step01 --> Step02
        Step02 --> Step03
        Step03 --> Step04
        Step04 --> Step05
    end

    %% 3. Error Handling (Global Trap)
    %% Representing the "Safety Net"
    subgraph TrapHandler [Global Error Trap]
        direction TB
        ErrorEvent(Any Failure)
        LogErr[Log Error Details]
        Cleanup[Restore/Cleanup]
        ExitFail((Exit 1))
    end

    %% 4. Connections
    Start --> LoadLib
    LoadLib --> CheckRoot
    
    CheckRoot -- No --> ErrorEvent
    CheckRoot -- Yes --> CheckDistro
    
    CheckDistro -- No --> ErrorEvent
    CheckDistro -- Yes --> Step00

    %% Visualizing that any step can trigger the Trap
    %% We use a dotted line to represent the "Interrupt" capability
    Step00 -.-> ErrorEvent
    Step01 -.-> ErrorEvent
    Step02 -.-> ErrorEvent
    Step03 -.-> ErrorEvent
    Step04 -.-> ErrorEvent   
    Step05 -.-> ErrorEvent

    Step05 --> Finish(((Success)))

    %% 5. Styling
    classDef script fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
    classDef init fill:#fff3e0,stroke:#e65100,stroke-width:1px;
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:1px;

    class Step00,Step01,Step02,Step03,Step04,Step05 script;
    class LoadLib,CheckRoot,CheckDistro init;
    class ErrorEvent,LogErr,Cleanup,ExitFail error;
